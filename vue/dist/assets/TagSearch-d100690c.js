import{P as U,a2 as Ae,d as Z,bg as me,aK as $e,v as z,bE as xe,s as ke,u as he,ag as X,a0 as ne,h as x,c as v,a as J,bF as we,b as Se,f as Pe,bG as Oe,bn as ce,bH as Te,aC as Be,i as Ne,aS as Ee,bI as Ke,bJ as Me,bK as Re,bL as De,a4 as Fe,aF as je,aD as Ue,bM as ze,aE as Le,bN as Ve,o as b,k as S,l as w,A as O,m as N,t as $,z as W,B,bO as Ge,p as Q,C as ye,bP as qe,R as _e,X as ie,q as be,r as He,bQ as We,bd as Qe,ai as Xe,au as Je,bR as de,bS as Ye,a3 as Ze,bT as ue,bU as ea,bV as aa,n as te,S as oe,I as ve,ah as ta,bW as na,a9 as pe,a6 as se,V as la,bX as oa,bY as sa,W as ia,bZ as ra,b_ as ca}from"./index-a5621346.js";import{S as da}from"./index-6c05bf07.js";/* empty css              *//* empty css              */var ua=function(){return{prefixCls:String,activeKey:{type:[Array,Number,String]},defaultActiveKey:{type:[Array,Number,String]},accordion:{type:Boolean,default:void 0},destroyInactivePanel:{type:Boolean,default:void 0},bordered:{type:Boolean,default:void 0},expandIcon:Function,openAnimation:U.object,expandIconPosition:U.oneOf(Ae("left","right")),collapsible:{type:String},ghost:{type:Boolean,default:void 0},onChange:Function,"onUpdate:activeKey":Function}},Ce=function(){return{openAnimation:U.object,prefixCls:String,header:U.any,headerClass:String,showArrow:{type:Boolean,default:void 0},isActive:{type:Boolean,default:void 0},destroyInactivePanel:{type:Boolean,default:void 0},disabled:{type:Boolean,default:void 0},accordion:{type:Boolean,default:void 0},forceRender:{type:Boolean,default:void 0},expandIcon:Function,extra:U.any,panelKey:U.oneOfType([U.string,U.number]),collapsible:{type:String},role:String,onItemClick:{type:Function}}};function fe(s){var e=s;if(!Array.isArray(e)){var a=Se(e);e=a==="number"||a==="string"?[e]:[]}return e.map(function(n){return String(n)})}const Y=Z({compatConfig:{MODE:3},name:"ACollapse",inheritAttrs:!1,props:me(ua(),{accordion:!1,destroyInactivePanel:!1,bordered:!0,openAnimation:$e("ant-motion-collapse",!1),expandIconPosition:"left"}),slots:["expandIcon"],setup:function(e,a){var n=a.attrs,c=a.slots,l=a.emit,o=z(fe(xe([e.activeKey,e.defaultActiveKey])));ke(function(){return e.activeKey},function(){o.value=fe(e.activeKey)},{deep:!0});var g=he("collapse",e),m=g.prefixCls,P=g.direction,T=X(function(){var f=e.expandIconPosition;return f!==void 0?f:P.value==="rtl"?"right":"left"}),k=function(r){var d=e.expandIcon,C=d===void 0?c.expandIcon:d,_=C?C(r):v(Te,{rotate:r.isActive?90:void 0},null);return v("div",null,[Be(Array.isArray(C)?_[0]:_)?ce(_,{class:"".concat(m.value,"-arrow")},!1):_])},R=function(r){e.activeKey===void 0&&(o.value=r);var d=e.accordion?r[0]:r;l("update:activeKey",d),l("change",d)},h=function(r){var d=o.value;if(e.accordion)d=d[0]===r?[]:[r];else{d=Ne(d);var C=d.indexOf(r),_=C>-1;_?d.splice(C,1):d.push(r)}R(d)},L=function(r,d){var C,_,D;if(!Oe(r)){var q=o.value,E=e.accordion,F=e.destroyInactivePanel,t=e.collapsible,i=e.openAnimation,p=String((C=r.key)!==null&&C!==void 0?C:d),I=r.props||{},y=I.header,K=y===void 0?(_=r.children)===null||_===void 0||(D=_.header)===null||D===void 0?void 0:D.call(_):y,M=I.headerClass,j=I.collapsible,H=I.disabled,G=!1;E?G=q[0]===p:G=q.indexOf(p)>-1;var u=j??t;(H||H==="")&&(u="disabled");var ee={key:p,panelKey:p,header:K,headerClass:M,isActive:G,prefixCls:m.value,destroyInactivePanel:F,openAnimation:i,accordion:E,onItemClick:u==="disabled"?null:h,expandIcon:k,collapsible:u};return ce(r,ee)}},V=function(){var r;return Pe((r=c.default)===null||r===void 0?void 0:r.call(c)).map(L)};return function(){var f,r=e.accordion,d=e.bordered,C=e.ghost,_=ne((f={},x(f,m.value,!0),x(f,"".concat(m.value,"-borderless"),!d),x(f,"".concat(m.value,"-icon-position-").concat(T.value),!0),x(f,"".concat(m.value,"-rtl"),P.value==="rtl"),x(f,"".concat(m.value,"-ghost"),!!C),x(f,n.class,!!n.class),f));return v("div",J(J({class:_},we(n)),{},{style:n.style,role:r?"tablist":null}),[V()])}}}),va=Z({compatConfig:{MODE:3},name:"PanelContent",props:Ce(),setup:function(e,a){var n=a.slots,c=z(!1);return Ee(function(){(e.isActive||e.forceRender)&&(c.value=!0)}),function(){var l,o;if(!c.value)return null;var g=e.prefixCls,m=e.isActive,P=e.role;return v("div",{ref:z,class:ne("".concat(g,"-content"),(l={},x(l,"".concat(g,"-content-active"),m),x(l,"".concat(g,"-content-inactive"),!m),l)),role:P},[v("div",{class:"".concat(g,"-content-box")},[(o=n.default)===null||o===void 0?void 0:o.call(n)])])}}}),le=Z({compatConfig:{MODE:3},name:"ACollapsePanel",inheritAttrs:!1,props:me(Ce(),{showArrow:!0,isActive:!1,onItemClick:function(){},headerClass:"",forceRender:!1}),slots:["expandIcon","extra","header"],setup:function(e,a){var n=a.slots,c=a.emit,l=a.attrs;Ke(e.disabled===void 0,"Collapse.Panel",'`disabled` is deprecated. Please use `collapsible="disabled"` instead.');var o=he("collapse",e),g=o.prefixCls,m=function(){c("itemClick",e.panelKey)},P=function(k){(k.key==="Enter"||k.keyCode===13||k.which===13)&&m()};return function(){var T,k,R,h,L=e.header,V=L===void 0?(T=n.header)===null||T===void 0?void 0:T.call(n):L,f=e.headerClass,r=e.isActive,d=e.showArrow,C=e.destroyInactivePanel,_=e.accordion,D=e.forceRender,q=e.openAnimation,E=e.expandIcon,F=E===void 0?n.expandIcon:E,t=e.extra,i=t===void 0?(k=n.extra)===null||k===void 0?void 0:k.call(n):t,p=e.collapsible,I=p==="disabled",y=g.value,K=ne("".concat(y,"-header"),(R={},x(R,f,f),x(R,"".concat(y,"-header-collapsible-only"),p==="header"),R)),M=ne((h={},x(h,"".concat(y,"-item"),!0),x(h,"".concat(y,"-item-active"),r),x(h,"".concat(y,"-item-disabled"),I),x(h,"".concat(y,"-no-arrow"),!d),x(h,"".concat(l.class),!!l.class),h)),j=v("i",{class:"arrow"},null);d&&typeof F=="function"&&(j=F(e));var H=Me(v(va,{prefixCls:y,isActive:r,forceRender:D,role:_?"tabpanel":null},{default:n.default}),[[Re,r]]),G=J({appear:!1,css:!1},q);return v("div",J(J({},l),{},{class:M}),[v("div",{class:K,onClick:function(){return p!=="header"&&m()},role:_?"tab":"button",tabindex:I?-1:0,"aria-expanded":r,onKeypress:P},[d&&j,p==="header"?v("span",{onClick:m,class:"".concat(y,"-header-text")},[V]):V,i&&v("div",{class:"".concat(y,"-extra")},[i])]),v(De,G,{default:function(){return[!C||r?H:null]}})])}}});Y.Panel=le;Y.install=function(s){return s.component(Y.name,Y),s.component(le.name,le),s};var pa={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M869 487.8L491.2 159.9c-2.9-2.5-6.6-3.9-10.5-3.9h-88.5c-7.4 0-10.8 9.2-5.2 14l350.2 304H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h585.1L386.9 854c-5.6 4.9-2.2 14 5.2 14h91.5c1.9 0 3.8-.7 5.2-2L869 536.2a32.07 32.07 0 000-48.4z"}}]},name:"arrow-right",theme:"outlined"};const fa=pa;function ge(s){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?Object(arguments[e]):{},n=Object.keys(a);typeof Object.getOwnPropertySymbols=="function"&&(n=n.concat(Object.getOwnPropertySymbols(a).filter(function(c){return Object.getOwnPropertyDescriptor(a,c).enumerable}))),n.forEach(function(c){ga(s,c,a[c])})}return s}function ga(s,e,a){return e in s?Object.defineProperty(s,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):s[e]=a,s}var re=function(e,a){var n=ge({},e,a.attrs);return v(Fe,ge({},n,{icon:fa}),null)};re.displayName="ArrowRightOutlined";re.inheritAttrs=!1;const ma=re;function ha(s,e,a,n){for(var c=-1,l=s==null?0:s.length;++c<l;){var o=s[c];e(n,o,a(o),s)}return n}function ya(s){return function(e,a,n){for(var c=-1,l=Object(e),o=n(e),g=o.length;g--;){var m=o[s?g:++c];if(a(l[m],m,l)===!1)break}return e}}var _a=ya();const ba=_a;function Ca(s,e){return s&&ba(s,e,je)}function Ia(s,e){return function(a,n){if(a==null)return a;if(!Ue(a))return s(a,n);for(var c=a.length,l=e?c:-1,o=Object(a);(e?l--:++l<c)&&n(o[l],l,o)!==!1;);return a}}var Aa=Ia(Ca);const $a=Aa;function xa(s,e,a,n){return $a(s,function(c,l,o){e(n,c,a(c),o)}),n}function ka(s,e){return function(a,n){var c=ze(a)?ha:xa,l=e?e():{};return c(a,s,Le(n),l)}}var wa=Object.prototype,Sa=wa.hasOwnProperty,Pa=ka(function(s,e,a){Sa.call(s,a)?s[a].push(e):Ve(s,a,[e])});const Oa=Pa;const Ta={class:"tag-wrap"},Ba={class:"float-actions"},Na=["title"],Ea=Z({__name:"TagSearchItem",props:{tag:{},name:{},selected:{type:Boolean},idx:{}},emits:["remove","toggleAnd","toggleNot","toggleOr","click"],setup(s){const e=(a,n=!1)=>(n?`[${a.type}] `:"")+(a.display_name?`${a.display_name} : ${a.name}`:a.name);return(a,n)=>{const c=ie;return b(),S("div",Ta,[w("div",Ba,[v(c,{size:"small",onClick:n[0]||(n[0]=l=>a.$emit("toggleAnd"))},{default:O(()=>[N($(a.$t("exactMatch")),1)]),_:1}),v(c,{size:"small",onClick:n[1]||(n[1]=l=>a.$emit("toggleOr"))},{default:O(()=>[N($(a.$t("anyMatch")),1)]),_:1}),v(c,{size:"small",onClick:n[2]||(n[2]=l=>a.$emit("toggleNot"))},{default:O(()=>[N($(a.$t("exclude")),1)]),_:1})]),w("li",{class:_e(["tag",{selected:a.selected}]),title:e(a.tag),onClick:n[4]||(n[4]=l=>a.$emit("click"))},[a.selected?(b(),W(B(Ge),{key:0})):Q("",!0),N(" "+$(e(a.tag))+" ",1),a.name==="custom"&&a.idx!==0?(b(),S("span",{key:1,class:"remove",onClickCapture:n[3]||(n[3]=ye(l=>a.$emit("remove"),["stop"]))},[v(B(qe))],32)):Q("",!0)],10,Na)])}}});const Ka=be(Ea,[["__scopeId","data-v-eaad7482"]]),Ma={class:"container"},Ra={class:"search-bar"},Da={class:"form-name"},Fa={class:"search-bar"},ja={class:"form-name"},Ua={class:"search-bar"},za={class:"form-name"},La={class:"search-bar"},Va={class:"form-name"},Ga={key:0,class:"generate-idx-hint"},qa={class:"list-container"},Ha=["onClick"],Wa={key:1},Qa={key:2,class:"spin-container"},Xa=Z({__name:"TagSearch",props:{tabIdx:{},paneIdx:{},searchScope:{}},setup(s){const e=s,a=He(),n=We(),c=X(()=>!n.isIdle),l=z(),o=z({and_tags:[],or_tags:[],not_tags:[],folder_paths_str:e.searchScope}),g=X(()=>l.value?l.value.tags.slice().sort((t,i)=>i.count-t.count):[]),m=["custom","Source Identifier","Model","lora","lyco","pos","size","Postprocess upscaler","Postprocess upscale by","Sampler"].reduce((t,i,p)=>(t[i]=p,t),{}),P=X(()=>Object.entries(Oa(g.value,t=>t.type)).sort((t,i)=>m[t[0]]-m[i[0]])),T=Qe(new Map),k=t=>T.get(t)??256,R=Xe(),h=z(P.value.map(t=>t[0]));Je(async()=>{console.log(new Date().toLocaleString()),l.value=await de(),await Ye(20),console.log(new Date().toLocaleString()),h.value=P.value.map(t=>t[0]),Ze(()=>{console.log(new Date().toLocaleString())}),l.value.img_count&&l.value.expired&&await L(),e.searchScope&&V()}),ue("searchIndexExpired",()=>l.value&&(l.value.expired=!0));const L=ea(()=>n.pushAction(async()=>(await ca(),l.value=await de(),h.value=P.value.map(t=>t[0]),l.value)).res),V=()=>{a.openTagSearchMatchedImageGridInRight(e.tabIdx,R,o.value)};ue("returnToIIB",async()=>{const t=await n.pushAction(aa).res;l.value.expired=t.expired});const f=(t,i=!1)=>(i?`[${t.type}] `:"")+(t.display_name?`${t.display_name} : ${t.name}`:t.name),r=z(!1),d=z(""),C=async()=>{var i,p,I;if(!d.value){r.value=!1;return}const t=await n.pushAction(()=>na({tag_name:d.value})).res;t.type!=="custom"&&pe.error(se("existInOtherType")),(i=l.value)!=null&&i.tags.find(y=>y.id===t.id)?pe.error(se("alreadyExists")):((p=l.value)==null||p.tags.push(t),(I=a.conf)==null||I.all_custom_tags.push(t)),d.value="",r.value=!1},_=t=>{la.confirm({title:se("confirmDelete"),async onOk(){var p,I,y,K;await oa({tag_id:t});const i=((p=l.value)==null?void 0:p.tags.findIndex(M=>M.id===t))??-1;(I=l.value)==null||I.tags.splice(i,1),(K=a.conf)==null||K.all_custom_tags.splice((y=a.conf)==null?void 0:y.all_custom_tags.findIndex(M=>M.id===t),1)}})},D=X(()=>new Set([o.value.and_tags,o.value.or_tags,o.value.not_tags].flat())),q=t=>{D.value.has(t.id)?(o.value.and_tags=o.value.and_tags.filter(i=>i!==t.id),o.value.or_tags=o.value.or_tags.filter(i=>i!==t.id),o.value.not_tags=o.value.not_tags.filter(i=>i!==t.id)):o.value.and_tags.push(t.id)},E={value:t=>t.id,text:f,optionText:t=>f(t,!0)},F=(t,i)=>{const p=i.indexOf(t);p===-1?i.push(t):i.splice(p,1)};return(t,i)=>{const p=ie,I=sa,y=ia,K=ie,M=ra,j=le,H=Y,G=da;return b(),S("div",Ma,[Q("",!0),l.value?(b(),S(te,{key:1},[w("div",null,[w("div",Ra,[w("div",Da,$(t.$t("exactMatch")),1),v(B(oe),{conv:E,mode:"multiple",style:{width:"100%"},options:g.value,value:o.value.and_tags,"onUpdate:value":i[0]||(i[0]=u=>o.value.and_tags=u),disabled:!g.value.length,placeholder:t.$t("selectExactMatchTag")},null,8,["options","value","disabled","placeholder"]),l.value.expired||!l.value.img_count?(b(),W(p,{key:0,onClick:B(L),loading:!B(n).isIdle,type:"primary"},{default:O(()=>[N($(l.value.img_count===0?t.$t("generateIndexHint"):t.$t("UpdateIndex")),1)]),_:1},8,["onClick","loading"])):(b(),W(p,{key:1,type:"primary",onClick:V,loading:!B(n).isIdle},{default:O(()=>[N($(t.$t("search")),1)]),_:1},8,["loading"]))]),w("div",Fa,[w("div",ja,$(t.$t("anyMatch")),1),v(B(oe),{conv:E,mode:"multiple",style:{width:"100%"},options:g.value,value:o.value.or_tags,"onUpdate:value":i[1]||(i[1]=u=>o.value.or_tags=u),disabled:!g.value.length,placeholder:t.$t("selectAnyMatchTag")},null,8,["options","value","disabled","placeholder"])]),w("div",Ua,[w("div",za,$(t.$t("exclude")),1),v(B(oe),{conv:E,mode:"multiple",style:{width:"100%"},options:g.value,value:o.value.not_tags,"onUpdate:value":i[2]||(i[2]=u=>o.value.not_tags=u),disabled:!g.value.length,placeholder:t.$t("selectExcludeTag")},null,8,["options","value","disabled","placeholder"])]),w("div",La,[w("div",Va,$(t.$t("searchScope")),1),v(I,{"auto-size":{maxRows:8},value:o.value.folder_paths_str,"onUpdate:value":i[3]||(i[3]=u=>o.value.folder_paths_str=u),placeholder:t.$t("specifiedSearchFolder")},null,8,["value","placeholder"])])]),g.value.filter(u=>u.type!=="custom").length?Q("",!0):(b(),S("p",Ga,$(t.$t("needGenerateIdx")),1)),w("div",qa,[(b(!0),S(te,null,ve(P.value,([u,ee])=>(b(),S("ul",{class:"tag-list",key:u},[w("h3",{class:"cat-name",onClick:A=>h.value.includes(u)?h.value.splice(h.value.indexOf(u),1):h.value.push(u)},[v(B(ma),{class:_e(["arrow",{down:h.value.includes(u)}])},null,8,["class"]),N(" "+$(t.$t(u)),1)],8,Ha),v(H,{ghost:"",activeKey:h.value,"onUpdate:activeKey":i[6]||(i[6]=A=>h.value=A)},{expandIcon:O(()=>[]),default:O(()=>[(b(),W(j,{key:u},{default:O(()=>[(b(!0),S(te,null,ve(ee.slice(0,k(u)),(A,Ie)=>(b(),W(Ka,{onClick:ae=>q(A),onRemove:ae=>_(A.id),onToggleAnd:ae=>F(A.id,o.value.and_tags),onToggleOr:ae=>F(A.id,o.value.or_tags),onToggleNot:ae=>F(A.id,o.value.not_tags),key:A.id,idx:Ie,name:u,tag:A,selected:D.value.has(A.id)},null,8,["onClick","onRemove","onToggleAnd","onToggleOr","onToggleNot","idx","name","tag","selected"]))),128)),u==="custom"?(b(),S("li",{key:0,class:"tag",onClick:i[5]||(i[5]=A=>r.value=!0)},[r.value?(b(),W(M,{key:0,compact:""},{default:O(()=>[v(y,{value:d.value,"onUpdate:value":i[4]||(i[4]=A=>d.value=A),style:{width:"128px"},loading:c.value,"allow-clear":"",size:"small"},null,8,["value","loading"]),v(K,{size:"small",type:"primary",onClickCapture:ye(C,["stop"]),loading:c.value},{default:O(()=>[N($(d.value?t.$t("submit"):t.$t("cancel")),1)]),_:1},8,["onClickCapture","loading"])]),_:1})):(b(),S(te,{key:1},[v(B(ta)),N(" "+$(t.$t("add")),1)],64))])):Q("",!0),k(u)<ee.length?(b(),S("div",Wa,[v(K,{block:"",onClick:A=>T.set(u,k(u)+256)},{default:O(()=>[N($(t.$t("loadmore")),1)]),_:2},1032,["onClick"])])):Q("",!0)]),_:2},1024))]),_:2},1032,["activeKey"])]))),128))])],64)):(b(),S("div",Qa,[v(G,{size:"large"})]))])}}});const at=be(Xa,[["__scopeId","data-v-dfed891b"]]);export{at as default};
